<!-- 
 *==========================================================================================
 * Date         : 08/19/2016
 * Developer    : Ahilesh Radhakrishnan
 * Purpose      : This VF page is built for the create/edit page for Custom Opportunity 
 *                contact role. Upon creation for Custom contact role records, 
 *                the corresponding standard Contact role will also get created.
 *==========================================================================================
 *                                 Update History
 *                                 ---------------
 * Date        Developer    Tag         Description
 *==========================================================================================
 * 01/17/2018| Raviteja   | T01 | Added SLDS changes
 * 03/21/2018| RaviTeja/  | T02 | Added the java script to populate the radio button after re-rendering the page.
               Debkanti
 * 09/11/2018| Naga       | T03 | Added Broker on record.
 *==========================================================================================
 -->

<apex:page lightningStylesheets="true" standardcontroller="Opportunity_Contact_Role__c" extensions="Opp_Contact_Role_RelatedList_Class" tabstyle="opportunity">
    <!--T01 - start -->
    <apex:slds rendered="{! !isClassic}"/>
  <apex:styleSheet value="{!$Resource.ModalDialogCSS}"/>
    <!--T01 - End -->

    <!--<!-- This is used for marking the current primary record in the radio button when the page loads-->
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script type="text/javascript">
                $j = jQuery.noConflict();
                $j(document).ready(function(){
                    
                          switch("{!currentPrimary}"){
                           case "100":
                            $j("#100").attr('checked', 'true');
                            break;
                            
                           case "1":
                            $j("#1").attr('checked', 'true');
                            break;

                           case "2":
                            $j("#2").attr('checked', 'true');
                            break;
                           
                           case "3":
                            $j("#3").attr('checked', 'true');
                            break;

                           case "4":
                            $j("#4").attr('checked', 'true');
                            break;
                           
                           case "5":
                            $j("#5").attr('checked', 'true');
                            break;
                }
              });
</script>
<!-- Hidden input to capture the selected primary radio button -->
<script>
function changeValue(input, textid) {
    document.getElementById(textid).value = input.value;
}   
</script>
    <!--T02 - Start -->
     <script>
function checkIt(){
    /*if (jQuery('.errorMsg').length > 0){
        // Error exists
        alert('There is an error on the page!');
     }
    else{
        alert('No errors!');
    }*/
    $j('.errorMsg').each( function() {
      if($j(this).text()=='Error:Primary can only be selected for Broker Agent of Record role'){ <!-- T03 9/11/2018 -->
          //alert($j(this).text());
          $j(this).closest('tr').find('.slds-radio').attr('checked', 'true');
          }
    });
}
    $j(document).on('click','.slds-radio',function(){
            if($j(this).attr('checked')){
                 $j('.slds-radio').attr('checked',false);
                // $j('input[type=hidden]').val('200');
                $j("[id*=RadioButtonValue]").val('200');
            }
            else{
                 $j('.slds-radio').not(this).attr('checked',false);
                    $j(this).attr('checked',true);
                }
            
            });
</script>
    <script>
    var myRadios = document.getElementsByName('chosen');
    var setCheck;
    var x = 0;
    for(x = 0; x < myRadios.length; x++){

    myRadios[x].onclick = function(){
        if(setCheck != this){
             setCheck = this;
        }else{
            this.checked = false;
            setCheck = null;
    }
    };

}
    </script>
    <!--T02 - End -->
    <!--T01 - start -->
   <!-- Added styles to display accordingly in lightning --> 
<style>
    {! if(! isClassic,'.pbButton{text-align: center !important;}.pbButton:last-child {padding-right: 45px !important;}','')}        
.detailList {
  width: 345px !important;
}   
   
.bPageBlock{
  border:none !important;
}
.apexp{
    margin-top: -30px;
}    
</style>
     
    

  
    <apex:form id="myForm" styleClass="slds-scope">
        <apex:actionFunction name="enableDates" action="{!enableDates}" rerender="renderInputSold" />
    <!--<apex:actionFunction name="submitBrfForArchApproval" action="{!lightningsaveContactRole}" rerender="myForm"/>-->
 <!-- Define a modal dialog box used to show status messages to the user. -->
    <apex:outputPanel styleClass="popupBackground" layout="block" rendered="{!displayPopUp}"/>
    <apex:outputPanel styleClass="popupBox" layout="block" rendered="{!displayPopUp}">
      <div align="center">
        <apex:outputText value="{!msg}"/><br/><br/><br/>
        <apex:commandButton value="Ok" action="{!returnToOpp}"/>
      </div>  
    </apex:outputPanel>
<!--T01    - End -->

        <!-- To pass Opportunity ID on page load-->
        <apex:outputText value="{!Opportunity_Contact_Role__c.Opportunity__c}" rendered="false"/>
         
        <!-- To display the Pageblock title -->
        <div class="bPageTitle">
            <div class="ptBody">
                <div class="content">
                    <img src="/s.gif" alt="Opportunity"  class="pageTitleIcon" title="Opportunity"/>
                    <h1 class="noSecondHeader pageType">Contact Roles for {!oppName}</h1>
                </div>
            </div>
        </div>
        
        <apex:pageBlock id="renderInputSold">

            <!-- Save and Cancel Buttons --> 
            <apex:pageBlockButtons >
                <!--<input type='button' value="Save" onclick="submitBrfForArchApproval();" class = "slds-button slds-button_neutral"/> --> 
                <apex:commandbutton value="Save" action="{!saveContactRole}" styleClass="slds-button slds-button_neutral" rerender="myForm" onComplete="checkIt()"/>              
                <apex:commandbutton value="Cancel" action="{!cancelContactRole}" styleClass="slds-button slds-button_neutral"/>
            </apex:pageBlockButtons>
            <apex:pageMessages ></apex:pageMessages>
            
            <!-- Table for output/input rows-->
            <table class="slds-table slds-table_bordered slds-table_cell-buffer" style="{! if(isClassic,'width:80%;border-spacing: 10px;','')}">
            <!--<apex:outputPanel id="renderInputSold">-->
              <tr class="slds-text-title_caps">
                <th scope="col">Primary</th>
                <th scope="col">Contact</th>
                <th scope="col">Role</th>
                <th scope="col">Effective Date</th>
                <th scope="col">End Date</th>
              </tr>
              <!--<apex:repeat value="{!wraplistOCR}" var="var" rendered="{!if(oppStage == 'Proposal',true,false)}">-->
              <apex:repeat value="{!wraplistOCR}" var="var" rendered="{!if((oppStage == 'Proposal' || oppStage == 'RFP' || oppStage == 'Benefit Request' || oppStage == 'Underwriting' || oppStage == 'Quote Delivered' || oppStage == 'ARC Approval' || oppStage == 'Prospecting'),true,false)}">

                  <tr>
                      <td>
                          <input type="radio" name="chosen" class='slds-radio'  id="{!var.index}" VALUE="{!var.index}" onclick="changeValue(this,'{!$Component.RadioButtonValue}');"/>     
                       </td>
                      <td>
                          <div class="slds-p-horizontal--small slds-size--5-of-12">
                            <div class="slds-form-element__control">
                                    <apex:inputfield value="{!var.OCRInst.Contact_Name__c}" />
                             </div>
                           </div>
                          
                      </td>
                      <td>
                         
                          <div class="slds-form-element__control">
                            <div class="slds-select_container">
                          <apex:inputfield value="{!var.OCRInst.Role__c}" styleclass="slds-select" />
                              </div>
                          </div>
                              <!--T01 - Start   Added style to show in classic and lightning accordingly-->
                          <div class="errorMsg" style="{!if(var.errorMsg != null && (var.oppRoleErrorMsg == true),'display:block','display:none')}">
                              <apex:outputText value="{!var.errorMsg}" rendered="{!if(var.errorMsg != null && (var.oppRoleErrorMsg == true),true,false)}"/>
                          </div>
                              <!--T01 - End -->
                      </td>
                      <td>
                          <apex:outputfield value="{!var.OCRInst.Effective_Date__c}"/>
                              <!--T01 - Start   Added style to show in classic and lightning accordingly-->
                          <div class="errorMsg" style="{!if(var.errorMsg != null && (var.oppEffDateErrorrenderv == true),'display:block','display:none')}">
                              <apex:outputText value="{!var.errorMsg}" rendered="{!if(var.errorMsg != null && (var.oppEffDateErrorrenderv == true),true,false)}"/>
                          </div>
                              <!--T01 - End -->
                      </td>
                      <td>
                          <apex:outputfield value="{!var.OCRInst.End_Date__c}"/>
                              <!--T01 - Start   Added style to show in classic and lightning accordingly-->
                          <div class="errorMsg" style="{!if(var.errorMsg != null && (var.oppEndDateErrorrenderv == true),'display:block','display:none')}">
                              <apex:outputText value="{!var.errorMsg}" rendered="{!if(var.errorMsg != null && (var.oppEndDateErrorrenderv == true),true,false)}"/>
                        </div>
                              <!--T01 - End -->

                      </td>
                  </tr>
              </apex:repeat>
              
              
              <!-- iterate the wrapper class list to display the current contact roles as output rows-->
              <apex:repeat value="{!wrapOutputListOCR}" var="var" rendered="{!if(oppStage == 'Sold',true,false)}">
                  <tr>
                      <td>
                          <apex:outputfield value="{!var.OCRInst.Primary__c}" rendered="{!if(var.OCRInst.Primary__c && (var.OCRInst.Role__c == 'Primary Broker' || var.OCRInst.Role__c == 'Consultant'),true,false)}"/>
                      </td>
                      <td>
                          <div class="slds-p-horizontal--small slds-size--5-of-12">
                            <div class="slds-form-element__control">
                          <apex:outputfield value="{!var.OCRInst.Contact_Name__c}" styleclass="slds-input"   />
                              </div>
                          </div>
                      </td>
                      <td>
                          <apex:outputfield value="{!var.OCRInst.Role__c}" />
                      </td>
                     
                      <td>
                          <apex:outputfield value="{!var.OCRInst.Effective_Date__c}"/>
                          <div class="errorMsg" style="{!if(var.errorMsg != null ,'display:block','display:none')}">
                              <apex:outputText value="{!var.errorMsg}" rendered="{!if(var.errorMsg != null ,true,false)}"/>
                          </div>
                      </td>
                      <td>
                          <apex:outputfield value="{!var.OCRInst.End_Date__c}"/>
                          <div class="errorMsg" style="{!if(var.errorMsg != null ,'display:block','display:none')}">
                              <apex:outputText value="{!var.errorMsg}" rendered="{!if(var.errorMsg != null ,true,false)}"/>
                          </div>
                      </td>
                  </tr>
              </apex:repeat>
              
               <!-- iterate the wrapper class list to display the contact roles as input rows-->
              <apex:repeat value="{!wrapInputListOCR}" var="var" rendered="{!if(oppStage == 'Sold',true,false)}">
              <tr>
                  <td></td>
                  <td>
                        <div class="slds-p-horizontal--small slds-size--5-of-12">
                            <div class="slds-form-element__control">
                                    <apex:inputfield value="{!var.OCRInst.Contact_Name__c}" />
                             </div>
                           </div>               
                  </td>
                  <td>
                    
                        <div class="slds-form-element__control">
                            <div class="slds-select_container">
                          <apex:inputfield value="{!var.OCRInst.Role__c}" onchange="enableDates()" styleclass="slds-select" />
                              </div>
                          </div>
                                                <div class="errorMsg" style="{!if(var.errorMsg != null && (var.oppRoleErrorMsg == true) ,'display:block','display:none')}">
                          <apex:outputText value="{!var.errorMsg}" rendered="{!if(var.errorMsg != null && (var.oppRoleErrorMsg == true),true,false)}"/>
                      </div>
                 </td>
                 
                  <td>
                      <apex:inputfield value="{!var.OCRInst.Effective_Date__c}" rendered="{!var.oppDatesEnable}"  />
                      <apex:outputfield value="{!var.OCRInst.Effective_Date__c}" rendered="{!!var.oppDatesEnable}" />
                      <div class="errorMsg" style="{!if(var.errorMsg != null  && (var.oppEffDateErrorrenderv == true) ,'display:block','display:none')}">
                          <apex:outputText value="{!var.errorMsg}" rendered="{!if(var.errorMsg != null && (var.oppEffDateErrorrenderv == true),true,false)}"/>
                      </div>
                  </td>
                  <td>
                      <apex:inputfield value="{!var.OCRInst.End_Date__c}" rendered="{!var.oppDatesEnable}" />
                      <apex:outputfield value="{!var.OCRInst.End_Date__c}" rendered="{!!var.oppDatesEnable}" />
                     <!-- <div class="errorMsg">
                          <apex:outputText value="{!var.errorMsg}" rendered="{!if(var.errorMsg != null,true,false)}"/>
                      </div>-->
                      <div class="errorMsg" style="{!if(var.errorMsg != null  && (var.oppEndDateErrorrenderv == true) ,'display:block','display:none')}">
                              <apex:outputText value="{!var.errorMsg}" rendered="{!if(var.errorMsg != null && (var.oppEndDateErrorrenderv == true),true,false)}"/>
                        </div>

                  </td>
                
              </tr>
              </apex:repeat>
             <!--</apex:outputPanel>-->
            </table>
            
            
            <!-- Hidden input to capture the selected primary radio button -->
            <apex:inputHidden value="{!selectedCR}" id="RadioButtonValue" />
            
        </apex:pageBlock>
    </apex:form>
   
</apex:page>
<!-- End of Page -->