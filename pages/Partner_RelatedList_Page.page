<!-- 
 *=================================================================================================
 * Date         : 08/21/2016
 * Developer    : Ahilesh Radhakrishnan
 * Purpose      : This is the VF page for the custom creation page for Partners(custom records).
 *                It will look like the standard partner creation page.
 *                Upon creation of Custom Partner records, the corresponding standard Partner 
 *                will also get created.
 *=================================================================================================
 *                                 Update History
 *                                 ---------------
 * Date         Developer         Tag     Description
 *============+=================+=====+============================================================
 * 01/17/2018 | Gayathri        | T01 | Added slds classes to match the look and feel of lightning 
 *                                      view with classic. 
 * 01/23/2018 | Rajesh Nagandla | T02 | Added SLDS to page to match lightning experience when 
 *                                      logged in as a lightning user. Added popup to indicate  
 *                                      the record is saved. This is added due to a salesforce 
 *                                      known issue in lightning. Known issue Reference Number: 
 *                                      W-3535908. Popup should be removed when the known issue
 *                                      is closed by Salesforce.
 *08/31/2018  |Naga Kandukoori  | T03 | Changed Primary label to Selling Broker, Changed Error msg
 *============+=================+=====+============================================================ 
 -->
<apex:page standardcontroller="Partner__c" extensions="Partner_RelatedList_Class" tabstyle="opportunity" lightningStylesheets="true">
<!-- T02 - Start -->
<apex:styleSheet value="{!$Resource.ModalDialogCSS}"/>
<!-- T02 - End -->
<!-- This is used for marking the current primary record in the radio button when the page loads-->
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script type="text/javascript">
                $j = jQuery.noConflict();
                $j(document).ready(function(){
                          switch("{!currentPrimary}"){
                           case "100":
                            $j("#100").attr('checked', 'true');
                            break;
                            
                           case "1":
                            $j("#1").attr('checked', 'true');
                            break;

                           case "2":
                            $j("#2").attr('checked', 'true');
                            break;
                           
                           case "3":
                            $j("#3").attr('checked', 'true');
                            break;

                           case "4":
                            $j("#4").attr('checked', 'true');
                            break;
                           
                           case "5":
                            $j("#5").attr('checked', 'true');
                            break;
                }
              });
</script>
<!-- Hidden input to capture the selected primary radio button -->
<script>
function changeValue(input, textid) {
    document.getElementById(textid).value = input.value;
} 

</script>
    <script>
function checkIt(){
    /*if (jQuery('.errorMsg').length > 0){
        // Error exists
        alert('There is an error on the page!');
     }
    else{
        alert('No errors!');
    }*/
    $j('.errorMsg').each( function() {
      if($j(this).text()=='Error:Selling Agency can only be selected for Broker role'){ <!--T03-->
          //alert($j(this).text());
          $j(this).closest('tr').find('.slds-radio').attr('checked', 'true');
          }
    });
}
    $j(document).on('click','.slds-radio',function(){
            if($j(this).attr('checked')){
                 $j('.slds-radio').attr('checked',false);
                // $j('input[type=hidden]').val('200');
                $j("[id*=RadioButtonValue]").val('200');
            }
            else{
                 $j('.slds-radio').not(this).attr('checked',false);
                    $j(this).attr('checked',true);
                }
            
            });
</script>
    <script>
    var myRadios = document.getElementsByName('chosen');
    var setCheck;
    var x = 0;
    for(x = 0; x < myRadios.length; x++){

    myRadios[x].onclick = function(){
        if(setCheck != this){
             setCheck = this;
        }else{
            this.checked = false;
            setCheck = null;
    }
    };

}
    </script>
 <!--T01 -- Start--- Style to display in both Classic and lightning respectively-->
<style>
   {! if(! isClassic,'.pbButton{text-align: center !important;}.pbButton:last-child {padding-right: 45px !important;}','')}  
    .detailList {
        width: 345px !important;
    }   
    .bPageBlock{
        border:none !important;
    }
</style>
    <apex:slds rendered="{!!isClassic}"/>
    <!--T01 --End-->
    <apex:form id="myForm">
    <!-- Define a modal dialog box used to show status messages to the user. -->
    <apex:outputPanel styleClass="popupBackground" layout="block" rendered="{!displayPopUp}"/>
    <apex:outputPanel styleClass="popupBox" layout="block" rendered="{!displayPopUp}">
      <div align="center">
        <apex:outputText value="{!msg}"/><br/><br/><br/>
        <apex:commandButton value="Ok" action="{!returnToOpp}"/>
      </div>  
    </apex:outputPanel>
    
        <apex:actionFunction name="enableDates" action="{!enableDates}" rerender="renderInputSold" />
        <!-- To pass Opportunity ID on page load -->
        <apex:outputText value="{!Partner__c.Opportunity__c}" rendered="false"/>
        <apex:outputPanel rendered="{!isClassic}">
        <!-- To display the Pageblock title -->
        <div class="bPageTitle">
            <div class="ptBody">
                <div class="content">
                    <img src="/s.gif" alt="Opportunity"  class="pageTitleIcon" title="Opportunity"/>
                    <h1 class="pageType">Partners
                        <span  class="titleSeparatingColon">:</span>
                    </h1>
                    <h2 class="pageDescription"> {!oppName}</h2>
                </div>
            </div>
        </div>
        </apex:outputPanel>
        <!--T01--Start--Header for the Page in Lightning view-->
        <apex:outputPanel rendered="{! !isClassic}">
            <div class="slds-page-header">
                <div class="slds-grid">
                     <div class="slds-col slds-has-flexi-truncate" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                    <div class="slds-media slds-no-space slds-grow">
                    <div class="slds-media__figure">
                        <svg class="slds-icon slds-icon-standard-user .slds-icon_small" aria-hidden="true">
                            <use xlink:href="{!URLFOR($Asset.SLDS, 'assets/icons/standard-sprite/svg/symbols.svg#opportunity')}"></use>
                        </svg>
                    </div>
                    <div class="slds-media__body">
                        <p class="slds-text-title_caps slds-line-height_reset">Partners</p>
                        <h1 class="slds-page-header__title slds-m-right_small slds-align-middle slds-truncate"
                            title="this should match the Record Title">{!oppName}</h1>
                    </div>
                </div>
            </div>          
            </div>
            </div>
        </apex:outputPanel>
        <!--T01--End-->
        <apex:pageBlock id="renderInputSold">
            <!-- Save and Cancel Buttons --> 
            <apex:pageBlockButtons >
                <div class="slds-grid slds-wrap slds-align--absolute-center">
                <apex:commandbutton value="Save" action="{!savePartner}" styleClass="slds-button slds-button_neutral" rerender="myForm" onComplete="checkIt()" />
                <apex:commandbutton value="Cancel" action="{!cancelPartner}"/> 
                </div>
            </apex:pageBlockButtons>
            
            <table  border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td class="pbTitle">
                    <h2 class="mainTitle slds-text-title--caps">Partners Edit</h2>
                </td>
            </tr>
            </table>
            <br/>
            
            <apex:pageMessages ></apex:pageMessages>
            
            <!-- Table for input rows-->
            <table style="{! if(isClassic,'width:80%;border-spacing: 10px;','')}" class="slds-table slds-table_bordered slds-table_cell-buffer">
              <tr class="slds-text-title--caps">
                <th>Selling Agency</th> <!-- T03 -->
                <th>Partner</th>
                <th>Role</th>
                <th>Effective Date</th>
                <th>End Date</th>
              </tr>
              
              <!--<apex:repeat value="{!wraplistPartner}" var="var" rendered="{!if((oppStage == 'Proposal'),true,false)}">-->
              <apex:repeat value="{!wraplistPartner}" var="var" rendered="{!if((oppStage == 'Proposal' || oppStage == 'RFP' || oppStage == 'Benefit Request' || oppStage == 'Underwriting' || oppStage == 'Quote Delivered' || oppStage == 'ARC Approval' || oppStage == 'Prospecting'),true,false)}">
                  <tr>
                      <td>
                          <input type="radio" name="chosen" class='slds-radio'  id="{!var.index}" VALUE="{!var.index}" onclick="changeValue(this,'{!$Component.RadioButtonValue}');"/>     
                      </td>
                      <td>
                          <div class="slds-p-horizontal--small slds-size--5-of-12">
                                <div class="slds-form-element__control">
                                    <apex:inputfield value="{!var.partnerInst.Partner__c}"/>
                                </div>
                          </div>
                      </td>
                      <td>
                          <div class="slds-form-element__control">
                                <div class="slds-select_container">
                                    <apex:inputfield value="{!var.partnerInst.Role__c}" styleclass="slds-select"/>
                                </div>
                          </div>
                      </td>
                      <td >
                          <apex:outputfield value="{!var.partnerInst.Effective_Date__c}"/>
                      </td>
                      <td>
                          <apex:outputfield value="{!var.partnerInst.End_Date__c}"/>
                          <!--T01--Start--Added style to display the error message in both classic and lightning accordingly-->
                          <div class="errorMsg" style="{!if(var.errorMsg != null,'display:block','display:none')}">
                              <apex:outputText value="{!var.errorMsg}" rendered="{!if(var.errorMsg != null,true,false)}"/>
                          </div>
                          <!--T01--End-->
                      </td>
                  </tr>
              </apex:repeat>
              
              <!-- iterate the wrapper class list to display the current contact roles as output rows-->
              <apex:repeat value="{!wrapOutputListPartner}" var="var" rendered="{!if(oppStage == 'Sold',true,false)}">
                  <tr>
                      <td>
                          <apex:outputfield value="{!var.partnerInst.Primary__c}" rendered="{!if(var.partnerInst.Primary__c && (var.partnerInst.Role__c == 'Broker' || var.partnerInst.Role__c == 'Consultant'),true,false)}"/>
                      </td>
                      <td>
                          <div class="slds-p-horizontal--small slds-size--5-of-12">
                             <apex:outputfield value="{!var.partnerInst.Partner__c}"/> 
                          </div>
                          
                      </td>
                      <td>
                          <apex:outputfield value="{!var.partnerInst.Role__c}"/>
                      </td>
                      <td>
                          <apex:outputfield value="{!var.partnerInst.Effective_Date__c}"/>
                      </td>
                      <td>
                          <apex:outputfield value="{!var.partnerInst.End_Date__c}"/>
                          <!--T01--Start--Added style to display the error message in both classic and lightning accordingly-->
                          <div class="errorMsg"  style="{!if(var.errorMsg != null,'display:block','display:none')}">
                              <b><apex:outputText value="{!var.errorMsg}" rendered="{!if(var.errorMsg != null,true,false)}"/></b>
                          </div>
                          <!--T01--End-->
                      </td>
                  </tr>
              </apex:repeat>
              
               <!-- iterate the wrapper class list to display the contact roles as input rows-->
              <apex:repeat value="{!wrapInputListPartner}" var="var" rendered="{!if(oppStage == 'Sold',true,false)}">
              <tr>
                  <td></td>
                  <td>
                      <div class="slds-p-horizontal--small slds-size--5-of-12">
                            <div class="slds-form-element__control">
                                <apex:inputfield value="{!var.partnerInst.Partner__c}" />
                            </div>
                      </div>
                  </td>
                  <td>
                      <div class="slds-form-element__control">
                            <div class="slds-select_container">
                                <apex:inputfield value="{!var.partnerInst.Role__c}" onchange="enableDates()"  styleclass="slds-select"/>
                            </div>
                      </div>
                 </td>
                  <td>
                      <!--<apex:inputfield value="{!var.partnerInst.Effective_Date__c}" />-->
                      <apex:inputfield value="{!var.partnerInst.Effective_Date__c}" rendered="{!var.oppDatesEnable}" styleclass="slds-input"/>
                      <apex:outputfield value="{!var.partnerInst.Effective_Date__c}" rendered="{!!var.oppDatesEnable}" />
                       <!--T01--Start--Added style to display the error message in both classic and lightning accordingly-->
                      <div class="errorMsg"  style="{!if(var.errorMsg != null,'display:block','display:none')}">
                          <apex:outputText value="{!var.errorMsg}" rendered="{!if(var.errorMsg != null,true,false)}"/>
                      </div>
                      <!--T01--End-->
                  </td>
                  <td>
                      <!--<apex:inputfield value="{!var.partnerInst.End_Date__c}" />-->
                      <apex:inputfield value="{!var.partnerInst.End_Date__c}" rendered="{!var.oppDatesEnable}" />
                      <apex:outputfield value="{!var.partnerInst.End_Date__c}" rendered="{!!var.oppDatesEnable}" />
                      <!--<div class="errorMsg">
                          <apex:outputText value="{!var.errorMsg}" rendered="{!if(var.errorMsg != null,true,false)}"/>
                      </div>-->
                  </td>
              </tr>
              </apex:repeat>
            </table>
            
             <!-- Hidden input to capture the selected primary radio button -->
            <apex:inputHidden value="{!selectedCR}" id="RadioButtonValue" />
            
        </apex:pageBlock>
    </apex:form>
   
</apex:page>
<!-- End of Page -->